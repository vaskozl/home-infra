apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: vm
  namespace: victoria-metrics
spec:
  chart:
    spec:
      chart: victoria-metrics-k8s-stack
      version: '0.67.0'
      sourceRef:
        kind: HelmRepository
        name: vm-charts
        namespace: flux-system
  interval: 24h0m0s
  targetNamespace: victoria-metrics
  install:
    crds: CreateReplace
  upgrade:
    crds: CreateReplace
  valuesFrom:
    - kind: Secret
      name: vm-secrets
  values:
    fullnameOverride: stack
    experimentalDashboardsEnabled: false
    grafana:
      image:
        registry: ghcr.io
        repository: vaskozl/grafana
        tag: 12.3.1@sha256:5b42774f97a73417d4e9a4a89869b2413392e173336855220878b9042ca5e4be
      route:
        main:
          enabled: true
          parentRefs:
            - name: internal
              namespace: agentgateway
          annotations:
            gethomepage.dev/enabled: "true"
            gethomepage.dev/description: Server Monitoring Dashboards
            gethomepage.dev/group: Monitoring
            gethomepage.dev/icon: grafana
            gethomepage.dev/name: Grafana
            gethomepage.dev/pod-selector: "app.kubernetes.io/name=grafana"
          hostnames:
            - gf.sko.ai
      sidecar:
        image:
          registry: ghcr.io
          repository: vaskozl/k8s-sidecar
          tag: 2.2.3@sha256:fa295780036bc329f50d7f8fe8bc5a8ed32a76340b5e1a7b53324e14bdb71cd0
        dashboards:
          enabled: true
          label: grafana_dashboard
          searchNamespace: ALL
      grafana.ini:
        auth.anonymous:
          enabled: true
          org_role: Editor
    alertmanager:
      route:
        parentRefs:
          - name: internal
            namespace: agentgateway
        enabled: true
        hostnames:
          - am.sko.ai
      spec:
        externalURL: "https://am.sko.ai"
        image:
          repository: ghcr.io/vaskozl/prometheus-alertmanager
          tag: 0.30.0@sha256:0e8eabcaebbc0ceff6016b241ba4a717ddfa7c6ae7020c2dda11354cf1b34c21
      config:
        route:
          routes:
            - matchers:
                - alertname=~"WatchDog|InfoInhibitor|KubeMemoryOvercommit"
              receiver: 'blackhole'
            - matchers:
                - severity=~"warning|critical"
              receiver: mail-monitoring
              repeat_interval: 24h
        receivers:
          - name: 'blackhole'
          - name: "mail-monitoring"
            email_configs:
              - to: alertmanager@sko.ai
                from: alertmanager@sko.ai
                hello: am.sko.ai
                smarthost: 'mx-maddy.mailserver.svc.cluster.local:2225'
                tls_config:
                  insecure_skip_verify: true
                send_resolved: true
                headers:
                  Subject: >
                    {{ if eq .Status "resolved" }}ðŸ‘Œ{{ end }} {{ if eq .Status "firing" }}ðŸš¨{{ end }} {{ index .CommonLabels.alertname
                    }}

                text: >
                  {{ range .Alerts }} {{ index .Annotations.description }} {{- end }}

                html: ''
    vmsingle:
      spec:
        retentionPeriod: "3"
        storage:
          resources:
            requests:
              storage: 22Gi
        resources:
          limits:
            memory: 1.2Gi
          requests:
            cpu: 530m
            memory: 1.2Gi
      route:
        enabled: true
        parentRefs:
          - name: internal
            namespace: agentgateway
        annotations:
          gethomepage.dev/enabled: "true"
          gethomepage.dev/description: Server Metrics
          gethomepage.dev/group: Monitoring
          gethomepage.dev/icon: victoriametrics
          gethomepage.dev/name: VictoriaMetrics
          gethomepage.dev/pod-selector: "app.kubernetes.io/name=vmsingle"
        hostnames:
          - vm.sko.ai
    vmalert:
      route:
        enabled: true
        parentRefs:
          - name: internal
            namespace: agentgateway
        hostnames:
          - va.sko.ai
    vmagent:
      spec:
        inlineScrapeConfig: |
          - job_name: "syno"
            static_configs:
            - targets: ["syno:9100"]
          - job_name: "pinewall"
            static_configs:
            - targets: ["pinewall:9100"]
          - job_name: "blocky"
            static_configs:
            - targets: ["pinewall:4000"]
        externalLabels:
          cluster: pi-cluster
        resources:
          limits:
            cpu: 1
            memory: 500Mi
          requests:
            cpu: 500m
            memory: 100Mi
      route:
        enabled: true
        hostnames:
          - vma.sko.ai
    kubelet:
      vmScrape:
        spec:
          # drop high cardinality label and useless metrics for cadvisor and kubelet
          metricRelabelConfigs:
            # Drop less useful container CPU metrics.
            - sourceLabels: [__name__]
              action: drop
              regex: 'container_cpu_(cfs_throttled_seconds_total|load_average_10s|system_seconds_total|user_seconds_total)'
            # Drop less useful / always zero container memory metrics.
            - sourceLabels: [__name__]
              action: drop
              regex: 'container_memory_(failures_total|mapped_file|swap)'
            # Drop less useful container process metrics.
            - sourceLabels: [__name__]
              action: drop
              regex: 'container_(file_descriptors|tasks_state|threads_max)'
            # Drop less useful container filesystem metrics.
            - sourceLabels: [__name__]
              action: drop
              regex: 'container_fs_(io_current|io_time_seconds_total|io_time_weighted_seconds_total|reads_merged_total|sector_reads_total|sector_writes_total|writes_merged_total)'
            # Drop less useful container blkio metrics.
            - sourceLabels: [__name__]
              action: drop
              regex: 'container_blkio_device_usage_total'
            # Drop container spec metrics that overlap with kube-state-metrics.
            - sourceLabels: [__name__]
              action: drop
              regex: 'container_spec.*'
            # Drop cgroup metrics with no pod.
            - sourceLabels: [id, pod]
              action: drop
              regex: '.+;'
            - action: drop
              sourceLabels: [__name__]
              regex: prober_probe_duration_seconds_bucket
            # Drop high-cardinality labels.
            - action: labeldrop
              regex: (uid|id|name|pod_uid|interface)
            - action: drop
              sourceLabels: [__name__]
              regex: (rest_client_request_duration_seconds_bucket|rest_client_request_duration_seconds_sum|rest_client_request_duration_seconds_count)
    # Not by most graphs or often useful
    kubeEtcd:
      enabled: false
    kubeControllerManager:
      enabled: false
    kubeProxy:
      enabled: false
    kubeScheduler:
      enabled: false
    kubeApiServer:
      enabled: false
    prometheus-node-exporter:
      extraArgs:
        - --collector.disable-defaults
        - --collector.uname
        - --collector.cpu
        - --collector.meminfo
        - --collector.nfs
