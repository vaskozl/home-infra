apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: mx
  annotations:
    patch.sko.ai/app-template: statefulset
spec:
  values:
    controller:
      replicas: &count 2
    image:
      repository: ghcr.io/docker-mailserver/docker-mailserver
      tag: 13.0.0@sha256:7aebcab5c256d5aec98ed42df9333d5a3c281c09b4f96887933f162c528327ee
    service:
      main:
        annotations:
          coredns.io/hostname: mail
        ports:
          http:
            enabled: false
          smtp:
            enabled: true
            port: 25
          smtp-secure:
            enabled: true
            port: 465
          smtp-auth:
            enabled: true
            port: 587
          imap:
            enabled: true
            port: 143
          imap-secure:
            enabled: true
            port: 993
          sieve:
            enabled: true
            port: 4190
          doveadm:
            enabled: true
            port: 4177
        type: LoadBalancer
        externalTrafficPolicy: Local
        externalIPs:
        - ${EI_MAILSERVER}
    envFrom:
    - secretRef:
        name: mailserver.env
    persistence:
      accounts:
        <<: &files
          enabled: true
          type: secret
          name: mailserver.files
        mountPath: /tmp/docker-mailserver/postfix-accounts.cf
        subPath: postfix-accounts.cf
      aliases:
        <<: *files
        mountPath: /tmp/docker-mailserver/postfix-aliases.cf
        subPath: postfix-aliases.cf
      virtual:
        <<: *files
        mountPath: /tmp/docker-mailserver/postfix-virtual.cf
        subPath: postfix-virtual.cf
      patches:
        <<: *files
        mountPath: /tmp/docker-mailserver/user-patches.sh
        subPath: user-patches.sh
      dkim-key-table:
        <<: &dkim
          enabled: true
          type: secret
          name: mailserver.dkim
        mountPath: /tmp/docker-mailserver/opendkim/KeyTable
        subPath: KeyTable
      dkim-signing-table:
        <<: *dkim
        mountPath: /tmp/docker-mailserver/opendkim/SigningTable
        subPath: SigningTable
      dkim-trusted-hosts:
        <<: *dkim
        mountPath: /tmp/docker-mailserver/opendkim/TrustedHosts
        subPath: TrustedHosts
      dkim-keys:
        enabled: true
        type: secret
        name: mailserver.opendkim.keys
        mountPath: /tmp/docker-mailserver/opendkim/keys/sko.ai-mail.key
        subPath: sko.ai-mail.key
      tls:
        enabled: true
        type: secret
        name: mail-sko-ai-tls
        mountPath: /etc/ssl/mailserver
    volumeClaimTemplates:
    - name: data
      mountPath: /var/mail
      size: 10Gi
      accessMode: ReadWriteOnce
      storageClass: nfs-client
    - name: mail-state
      mountPath: /var/mail-state
      size: 1Gi
      accessMode: ReadWriteOnce
    resources:
      limits:
        memory: 2Gi
        cpu: 1500m
      requests:
        memory: 250Mi
        cpu: 150m
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      runAsUser: 0
      runAsGroup: 0
      runAsNonRoot: false
      privileged: false
      capabilities:
        add:
        - CHOWN
        - FOWNER
        - MKNOD
        - SETGID
        - SETUID
        - DAC_OVERRIDE
        - NET_ADMIN # needed for F2B
        - NET_RAW # needed for F2B
        - NET_BIND_SERVICE
        - SYS_CHROOT
        - SYS_PTRACE
        - KILL
        drop: [ALL]
      seccompProfile:
        type: RuntimeDefault
    probes:
      liveness: &probes
        enabled: true
        custom: true
        spec:
          exec:
            command:
            - sh
            - -c
            - 'postfix status && doveadm service status health-check'
          initialDelaySeconds: 15
          periodSeconds: 20
      readiness: *probes
