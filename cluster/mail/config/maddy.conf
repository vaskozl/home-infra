# ----------------------------------------------------------------------------
# Base variables
# ----------------------------------------------------------------------------

$(hostname) = mail.sko.ai
$(primary_domain) = sko.ai
$(local_domains) = $(primary_domain) skozl.com

tls file /etc/maddy/certs/$(hostname)/tls.crt /etc/maddy/certs/$(hostname)/tls.key

# ----------------------------------------------------------------------------
# Local storage & authentication
# ----------------------------------------------------------------------------

auth.pass_table local_authdb {
    table sql_table {
        driver sqlite3
        dsn credentials.db
        table_name passwords
    }
}

storage.imapsql local_mailboxes {
    driver sqlite3
    dsn imapsql.db

   imap_filter {
       command /bin/sh /etc/maddy/sieve.sh {sender} {subject} {rcpt_to}
   }
}

# ----------------------------------------------------------------------------
# SMTP endpoints + message routing
# ----------------------------------------------------------------------------

hostname $(hostname)

table.chain local_rewrites {
    optional_step regexp "(.+)\+(.+)@(.+)" "$1@$3"
    optional_step static {
        entry postmaster postmaster@$(primary_domain)
    }
    optional_step file /etc/maddy/aliases
}

msgpipeline local_routing {
    modify {
        replace_rcpt &local_rewrites
    }

    check {
        rspamd {
            api_path http://mx-rspamd:11333
        }
    }

    # at this point rcpt was normalized to either:
    #       postmaster@$(primary_domain),
    #       local_mailbox_without_tag@$(local_domains),
    #       replacements with alias

    # destination_in block takes priority over destinations
    destination_in &local_mailboxes {
        deliver_to &local_mailboxes
    }

    destination_in file /var/lib/maddy/blacklist {
        reject 550 5.1.1 "User doesn't exist"
    }

    # if rcpt is not in local_mailboxes, but has our domains,
    # replace rcpt to catchall and deliver it there
    destination $(local_domains) {
        modify {
            replace_rcpt regexp ".*" "{env:CATCH_USER}"
        }
        deliver_to &local_mailboxes
    }

    default_destination {
        reject 550 5.1.1 "User doesn't exist"
    }
}

smtp tcp://0.0.0.0:25 {
    limits {
        # Up to 20 msgs/sec across max. 10 SMTP connections.
        all rate 20 1s
        all concurrency 10
    }

    dmarc yes
    check {
        require_mx_record
        dkim
        #spf
    }

    source $(local_domains) {
        reject 501 5.1.8 "Use Submission for outgoing SMTP"
    }
    default_source {
        destination postmaster $(local_domains) {
            deliver_to &local_routing
        }
        default_destination {
            reject 550 5.1.1 "User doesn't exist"
        }
    }
}

smtp tcp://0.0.0.0:2225 {
    limits { all rate 50 1s }

    source $(local_domains) {
        destination postmaster $(local_domains) {
            deliver_to &local_routing
        }
        default_destination {
            deliver_to &remote_queue
        }
    }

    default_source {
        reject 501 5.1.8 "Non-local sender domain"
    }
}

submission tls://0.0.0.0:465 tcp://0.0.0.0:587 {
    limits { all rate 50 1s }

    auth &local_authdb

    source $(local_domains) {
        check {
            authorize_sender {
                prepare_email &local_rewrites
                user_to_email identity
            }
        }

        destination postmaster $(local_domains) {
            deliver_to &local_routing
        }
        default_destination {
            deliver_to &remote_queue
        }
    }
    default_source {
        reject 501 5.1.8 "Non-local sender domain"
    }
}

target.smtp outbound_delivery {
    require_tls
    targets tcp://smtp.eu.mailgun.org:587
    auth plain {env:RELAY_USER} {env:RELAY_PASSWORD}
}

target.queue remote_queue {
    target &outbound_delivery

    autogenerated_msg_domain $(primary_domain)
    bounce {
        destination postmaster $(local_domains) {
            deliver_to &local_routing
        }
        default_destination {
            reject 550 5.0.0 "Refusing to send DSNs to non-local addresses"
        }
    }
}

# ----------------------------------------------------------------------------
# IMAP endpoints
# ----------------------------------------------------------------------------

imap tls://0.0.0.0:993 tcp://0.0.0.0:143 {
    auth &local_authdb
    storage &local_mailboxes
}
