apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: kube-network-policies
spec:
  template:
    spec:
      hostNetwork: true
      priorityClassName: system-node-critical
      nodeSelector:
        kubernetes.io/os: linux
      tolerations:
        - operator: Exists
          effect: NoSchedule
      serviceAccountName: kube-network-policies
      containers:
        - name: kube-network-policies
          image: ghcr.io/vaskozl/kube-network-policies:0.9.1@sha256:ac6184066fb3eb2937b1ba46919039babab021f49e945a1739719a26db3f2b9a
          args:
            - --hostname-override=$(MY_NODE_NAME)
            - -v=1
          volumeMounts:
            - name: nri-plugin
              mountPath: /var/run/nri
            - name: netns
              mountPath: /var/run/netns
              mountPropagation: HostToContainer
          resources:
            requests:
              cpu: "100m"
              memory: "50Mi"
          securityContext:
            privileged: true
            runAsUser: 0
            capabilities:
              add: ["NET_ADMIN"]
          env:
            - name: MY_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
      volumes:
        - name: nri-plugin
          hostPath:
            path: /var/run/nri
        - name: netns
          hostPath:
            path: /var/run/netns
