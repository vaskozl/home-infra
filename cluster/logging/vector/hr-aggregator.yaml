apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: vector-aggregator
spec:
  interval: 1h
  chart:
    spec:
      chart: vector
      version: 0.32.0
      sourceRef:
        kind: HelmRepository
        name: vector-charts
        namespace: flux-system
      interval: 1h
  values:
    role: Aggregator
    customConfig:
      data_dir: /vector-data-dir
      expire_metrics_secs: 60
      sources:
        vector:
          address: 0.0.0.0:6000
          type: vector
          version: "2"
      transforms:
        vmlogs-remap:
          type: remap
          inputs: [vector]
          source: |-
            .labels = .kubernetes.pod_labels
            .app = .labels."app.kubernetes.io/instance" || .labels.app || .labels."k8s-app" || "unkown"
            .namespace = .kubernetes.pod_namespace
            .node = .kubernetes.pod_node_name
            .container = .kubernetes.container_name
            .pod = .kubernetes.pod_name

            del(.kubernetes)
            del(.labels)

            # Parse key/value (logfmt) logs
            .parsed = parse_key_value!(.message)
        sort:
          type: remap
          inputs: [vector]
          source: |-
            .labels = .kubernetes.pod_labels
            .app = .labels."app.kubernetes.io/instance" || .labels.app || .labels."k8s-app" || "unkown"
            .filename = .app || .kubernetes.container_name || "unlabeled";

            .folder = .kubernetes.pod_namespace || "unlabeled"

            .pod = string!(.kubernetes.pod_name)
            .ctr = string!(.kubernetes.container_name)
            .str = string!(.stream)
            .msg = string!(.message)

            .message = .msg + " pod=" + .pod + " ctr=" + .ctr + " str=" + .str
      sinks:
        files:
          type: file
          inputs: [sort]
          encoding:
            codec: raw_message
          path: /var/log/k8s/{{ "{{" }} .folder {{ "}}" }}/{{ "{{" }} .filename {{ "}}" }}-%Y%m%d.log
        vmlogs:
          inputs: ["vmlogs-remap"]
          type: elasticsearch
          endpoints:
            - http://victoria-metrics-vm-logs-victoria-logs-single-server.victoria-metrics.svc:9428/insert/elasticsearch/
          mode: "bulk"
          compression: gzip
          api_version: "v8"
          healthcheck:
            enabled: false
          query:
            _msg_field: "message"
            _stream_fields: "node,container,app,namespace"
    extraVolumes:
      - name: logging-pvc
        persistentVolumeClaim:
          claimName: logging-pvc
    extraVolumeMounts:
      - name: logging-pvc
        mountPath: /var/log/k8s
