apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitlab
  namespace: gitlab
spec:
  interval: 1h
  chart:
    spec:
      chart: gitlab
      version: 9.2.1
      sourceRef:
        kind: HelmRepository
        name: gitlab
        namespace: flux-system
      interval: 1h
  values:
    global:
      gitlabBase:
        image:
          repository: ghcr.io/vaskozl/gitlab-base
          tag: 18.2.1@sha256:3c8000363ab5599c3571c57bb8f7075a54700bc7d533ec27cd3b5dd2c56166c8
      certificates:
        image:
          repository: ghcr.io/vaskozl/gitlab-certificates
          tag: 18.2.1@sha256:a47a5d50671c8d636b51a97cdc21b957b4e09eba3a942b64b1de53daa3030981
      extraEnv:
        GITLAB_LOG_LEVEL: 'error'
        GITLAB_LOGGER_TRUNCATE_LOGS: true
      nodeSelector:
        kubernetes.io/arch: amd64
      edition: ce
      hosts:
        domain: sko.ai
      ingress:
        class: &class haproxy-internal
        provider: *class
        # Wildcard is configured by default
        configureCertmanager: false
        # TLS is enabled by default
        tls:
          enabled: false
      kas:
        enabled: false
      pages:
        enabled: true
      email:
        display_name: 'GitLab'
        from: 'gitlab@sko.ai'
        reply_to: 'noreply@sko.ai'
      smtp:
        enabled: true
        address: 'mail.sko.ai'
        port: 2225
        tls: false
        authentication: ''
      redis:
        host: gitlab-redis
        auth:
          secret: gitlab-redis-secret
          key: secret
      psql:
        host: gitlab-postgresql
        password:
          secret: gitlab-postgresql-password
          key: postgresql-password
      minio:
        enabled: false
      appConfig:
        omniauth:
          enabled: true
          autoSignInWithProvider: []
          syncProfileFromProvider: [openid_connect]
          allowSingleSignOn: [openid_connect]
          allowBypassTwoFactor: [openid_connect]
          syncProfileAttributes: [email]
          blockAutoCreatedUsers: false
          providers:
            - secret: authelia-oauth2
        lfs: &rails
          connection:
            secret: object-storage
            key: rails.minio.yaml
        artifacts: *rails
        uploads: *rails
        packages: *rails
        externalDiffs: *rails
        terraformState: *rails
        dependencyProxy: *rails
        ciSecureFiles: *rails
    # Reduce memory usage
    gitlab:
      gitlab-exporter:
        image:
          repository: ghcr.io/vaskozl/gitlab-exporter
          tag: 18.2.1@sha256:7e714af51ca5fa2642b23f6e8f72b473557916bf1fc347936db00a0da147729d
      gitaly:
        image:
          repository: ghcr.io/vaskozl/gitaly
          tag: 18.2.1@sha256:7c0d8625d57e5a3c1070e54245934c95afca34e4520b9f45c03fd32c49e615df
        resources:
          requests:
            cpu: 80m
            memory: 660M
          limits:
            memory: 660M
      webservice:
        minReplicas: 1
        maxReplicas: 2
        # https://gitlab.com/gitlab-org/charts/gitlab/-/blob/master/examples/ref/2k.yaml
        workerProcesses: 1
        resources:
          limits:
            memory: 2Gi
          requests:
            cpu: 100m
            memory: 2Gi
      sidekiq:
        minReplicas: 1
        maxReplicas: 2
      gitlab-shell:
        image:
          repository: ghcr.io/vaskozl/gitlab-shell
          tag: 18.2.1@sha256:31b01b0f800464d7a747ecf79a0f50f1c5946424a7e02e503f31d6023cc39977
        minReplicas: 1
        maxReplicas: 2
      gitlab-pages:
        image:
          repository: ghcr.io/vaskozl/gitlab-pages
          tag: 18.2.1@sha256:956c618a2fa21d38f105b8750f5da6e198bce3bbb9bd93ab33a0044a44a3c967
        # The default requests are massive for a static server
        resources:
          requests:
            cpu: 10m
            memory: 10Mi
      toolbox:
        backups:
          objectStorage:
            config:
              secret: object-storage
              key: toolbox.minio.toml
    registry:
      image:
        repository: ghcr.io/vaskozl/gitlab-container-registry
        tag: 18.2.1@sha256:7ab3ade640d1778aa6a02ef41119e43a826beaacd7538522a4e614e7ebbe7a7c
      ingress:
        annotations:
          haproxy.org/timeout-server: 600s
      storage:
        secret: object-storage
        key: registry.minio.yaml
    # Disable things we handle by ourselves
    certmanager:
      install: false
    nginx-ingress:
      enabled: false
    prometheus:
      install: false
    grafana:
      enabled: false
    gitlab-runner:
      concurrent: 1
      runners:
        nodeSelector:
          kubernetes.io/arch: amd64
        config: |
          [[runners]]
            [runners.kubernetes]
              helper_image = "ghcr.io/vaskozl/gitlab-runner-helper:18.2.1@sha256:f34163a3431eaa1cc10a1b1bc1e62ff3f74314ff70036b4324f826c1e2e738cc"
              cpu_request = "500m"
              cpu_limit = "1"
              memory_request = "300Mi"
              memory_limit = "2Gi"
              service_cpu_request = "100m"
              service_cpu_limit = "1"
              service_memory_request = "50Mi"
              service_memory_limit = "1Gi"
              helper_cpu_request = "5m"
              helper_cpu_limit = "500m"
              helper_memory_request = "50Mi"
              helper_memory_limit = "200Mi"
              # Used by melange
              privileged = true
              [runners.kubernetes.node_selector]
                "kubernetes.io/arch" = "amd64"
      image:
        registry: ghcr.io
        image: vaskozl/gitlab-runner
        tag: 18.2.1@sha256:ab3d93cbe4ec55b8713430f931a3f021de99c3c833c504941577c003fc655674
    redis:
      install: false
    postgresql:
      install: true
  postRenderers:
    - kustomize:
        patches:
          - patch: |-
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: dummy-app
              spec:
                template:
                  spec:
                    nodeSelector:
                      kubernetes.io/arch: amd64
            target:
              kind: Deployment
          - patch: |-
              apiVersion: apps/v1
              kind: StatefulSet
              metadata:
                name: dummy-app
              spec:
                template:
                  spec:
                    nodeSelector:
                      kubernetes.io/arch: amd64
            target:
              kind: StatefulSet
