apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitlab-runner-arm64
  namespace: gitlab
spec:
  interval: 24h
  chart:
    spec:
      chart: gitlab-runner
      version: 0.85.0
      sourceRef:
        kind: HelmRepository
        name: gitlab
        namespace: flux-system
      interval: 24h
  values:
    gitlabUrl: https://gitlab.sko.ai
    concurrent: 1
    rbac:
      create: true
    serviceAccount:
      create: true
    runners:
      secret: arm64-gitlab-runner-secret
      runUntagged: false
      tags: [arm64]
      nodeSelector:
        kubernetes.io/arch: arm64
      config: |
        [[runners]]
          [runners.kubernetes]
            helper_image = "ghcr.io/vaskozl/gitlab-runner-helper:latest"
            cpu_request = "500m"
            cpu_limit = "1"
            memory_request = "1Gi"
            memory_limit = "4Gi"
            service_cpu_request = "100m"
            service_cpu_limit = "1"
            service_memory_request = "50Mi"
            service_memory_limit = "1Gi"
            helper_cpu_request = "5m"
            helper_cpu_limit = "500m"
            helper_memory_request = "50Mi"
            helper_memory_limit = "200Mi"
            # Used by dind
            privileged = true
            [[runners.kubernetes.volumes.empty_dir]]
              name = "docker-emptydir"
              mount_path = "/var/run"
              medium = "Memory"
            [[runners.kubernetes.volumes.pvc]]
              name = "apk-repo-pvc"
              mount_path = "/apks"
            [runners.kubernetes.node_selector]
              "kubernetes.io/arch" = "arm64"
    image:
      registry: ghcr.io
      image: vaskozl/gitlab-runner
      repository: vaskozl/gitlab-runner
      tag: 18.8.0@sha256:16ebc799e68d02d57d36d153b5bd3a9b3c4d6fa5f991f47419a6cac405a80188
