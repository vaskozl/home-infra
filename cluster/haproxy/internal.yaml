apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: internal
spec:
  interval: 24h
  chart:
    spec:
      chart: kubernetes-ingress
      sourceRef:
        kind: HelmRepository
        name: haproxytech
        namespace: flux-system
      version: 1.47.3
  values:
    controller:
      replicaCount: 3
      ingressClass: haproxy-internal
      ingressClassResource:
        name: haproxy-internal
        default: true
      service:
        type: LoadBalancer
        loadBalancerClass: minilb
        tcpPorts:
          - name: ssh
            port: 22
            targetPort: 22
      extraArgs:
        - --default-ssl-certificate=cert-manager/sko-ai-tls
        - --configmap-tcp-services=haproxy/tcp-internal
      tolerations:
        - effect: NoSchedule
          operator: Exists
      containerPort:
        http: 80
        https: 443
        stat: 1024
      config:
        request-set-header: X-Ingress-Class "haproxy-internal"
        load-balance: leastconn
        syslog-server: "address:stdout, format: raw, facility:daemon"
        scale-server-slots: "2"
        log-format: "ip=%ci dt=%tr backend=%b perf=%TR/%Tw/%Tc/%Tr/%Ta code=%ST bytes_read=%B term=%tsc metrics=%ac/%fc/%bc/%sc/%rc
          srv_queue=%sq  backend_queue=%bq ua=%{+Q}[capture.req.hdr(0)] host=%{+Q}[capture.req.hdr(1)] ver=%HV method=%HM uri=%HU"
        frontend-config-snippet: |
          # Capture headers for logging
          capture request header User-Agent len 64
          capture request header Host len 64

          # Security Headers
          http-response set-header X-XSS-Protection "1; mode=block"
          http-response set-header X-Content-Type-Options "nosniff"
          http-response set-header X-Frame-Options "sameorigin"
          http-response set-header Referrer-Policy "strict-origin-when-cross-origin"
      resources:
        requests:
          memory: 250Mi
          cpu: 25m
        limits:
          memory: 500Mi
