apiVersion: operator.victoriametrics.com/v1beta1
kind: VMRule
metadata:
  name: container-vulns-alerts
spec:
  groups:
    - name: container-vulns
      interval: 1m
      rules:
        - alert: ContainerCriticalVulns
          expr: |
            max_over_time(sum(scanner_vulnerabilities{severity=~"Critical|High"}) by (image, id, pkg)[1h:]) > 0
          for: 2h
          labels:
            severity: critical
          annotations:
            summary: "Critical/High vulnerability in {{ $labels.image }}"
            description: |
              Container {{ $labels.image }} has a Critical/High vulnerability:
              CVE: {{ $labels.id }}
              Package: {{ $labels.pkg }}

        - alert: ContainerMediumVulnsFixAvailable
          expr: |
            max_over_time(sum(scanner_vulnerabilities{severity="Medium"} unless scanner_vulnerabilities{severity="Medium",fixable="yes"}) by (image, id, pkg)[1h:]) > 0
          for: 24h
          labels:
            severity: warning
          annotations:
            summary: "Medium vulnerability with fix in {{ $labels.image }}"
            description: |
              Container {{ $labels.image }} has a Medium vulnerability with a fix available:
              CVE: {{ $labels.id }}
              Package: {{ $labels.pkg }}

        - alert: ContainerLowVulnsFixAvailable
          expr: |
            max_over_time(sum(scanner_vulnerabilities{severity="Low"} unless scanner_vulnerabilities{severity="Low",fixable="yes"}) by (image, id, pkg)[1h:]) > 0
          for: 24h
          labels:
            severity: info
          annotations:
            max_over_time(summary: "Low vulnerability with fix in {{ $labels.image }}"
            description: |
              Container {{ $labels.image }} has a Low vulnerability with a fix available:
              CVE: {{ $labels.id }}
              Package: {{ $labels.pkg }}

        - alert: ContainerTooManyVulns
          expr: |
            max_over_time(sum(scanner_vulnerabilities) by (image)[1h:]) > 20
          for: 1h
          labels:
            severity: warning
          annotations:
            summary: "Too many vulnerabilities in {{ $labels.image }}"
            description: |
              Container {{ $labels.image }} has more than 20 vulnerabilities in total.
