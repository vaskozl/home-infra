apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: oauth2-policy
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: internal
  traffic:
    extAuth:
      backendRef:
        # Doesn't work
        name: oauth2-proxy
        namespace: oauth2-proxy
        port: 4180
      forwardBody:
        maxSize: 1024
      http:
        path: |
          "/oauth2/auth"
        redirect: |
          "https://auth.sko.ai/oauth2/start?rd=" + request.scheme + "://" + request.host + request.path
        allowedRequestHeaders:
        - Cookie
        addRequestHeaders:
          x-forwarded-proto: request.scheme
          x-forwarded-host: request.host
          x-forwarded-uri: request.path
        allowedResponseHeaders:
        - x-auth-request-user
